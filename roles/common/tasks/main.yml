---
- name: Common | set up fstrim if ssdisk
  ansible.builtin.systemd:
    name: fstrim.timer
    state: started
    enabled: true

- name: Common | copy dnf-automatic files
  ansible.builtin.copy:
     src: dnf
     dest: /etc/dnf/
     owner: root
     group: root
     mode: 0644

- name: Common | install some basic packages
  ansible.builtin.dnf:
    name: "{{ dnf_items }}"
    state: present
  vars:
    dnf_items:
      - sysstat
      - python3-dnf
      - python3-dnf-plugins-core
      - dnf-automatic
      - smartmontools

- name: Common | activate dnf-automatic
  ansible.builtin.systemd:
    name: dnf-automatic-install.timer
    state: started
    enabled: true

- name: Common | set the fqdn
  ansible.builtin.command: "hostnamectl set-hostname {{ inventory_hostname }}.{{ cluster_domain }}"

- name: Common | template the hosts file
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
    mode: 0644

- name: Common | enable crp on EL
  shell: "dnf config-manager --set-enabled crb -y"
  when: ansible_distribution_major_version == '9'

- name: Common | add distro-specific repos
  dnf:
    name: "{{ additional_repo_pkgs[ansible_distribution_major_version] }}"
    state: installed
    disable_gpg_check: yes

- name: Common | add-on for fedora
  shell: "dnf groupupdate {{ item }} -y"
  loop:
    - 'core'
    - 'multimedia --setop="install_weak_deps=False" --exclude=PackageKit-gstreamer-plugin --exclude=gstreamer1-plugins-ugly'
    - 'sound-and-video'
  when: ansible_distribution_major_version in ['37', '38']

- name: Common | update it all
  dnf:
    name: "*"
    state: latest
    disable_gpg_check: yes

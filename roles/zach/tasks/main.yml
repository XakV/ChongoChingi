---
- name: install a few normal things
  ansible.builtin.dnf:
    name: ['tilix', 'vim', 'buildah', 'syncthing']
    state: present

- name: install wezterm nightly
  ansible.builtin.dnf:
    name: https://github.com/wez/wezterm/releases/download/nightly/wezterm-nightly-fedora36.rpm
    state: present
    disable_gpg_check: yes
  when: ansible_distribution_major_version == '36'

- name: make vim right
  ansible.builtin.shell: |
    curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  become: yes
  become_user: zach

- name: start up user services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: yes
    daemon-reload: yes
    state: restarted
    scope: user
  become_user: zach
  loop:
    - syncthing
    - podman.socket
    - podman-auto-update.timer

- name: Add the flathub flatpak repository remote to the user installation
  flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
    method: user
  become_user: zach

- name: install the flattened paks
  flatpak:
    name: "{{ item }}"
    state: present
    method: user
  become_user: zach
  loop: "{{ flatpaks }}"

- name: set up directories
  ansible.builtin.file:
    path: "/home/zach/{{ item.dir }}"
    state: directory
    owner: zach
    group: zach
    mode: "{{ item.mode }}"
  loop: dotdirs

- name: copy dotfiles
  ansible.builtin.copy:
    src: "{{ item.source }}"
    dest: "{{ item.dest }}"
    owner: zach
    group: zach
    mode: "{{ item.mode }}"
  loop: dotfiles

- name: set up poetry
  ansible.builtin.shell: curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
  args:
    creates: "{{ ansible_user_dir }}/.poetry/bin/poetry"

- name: install pipx
  ansible.builtin.pip:
    name: pipx
    state: present
    extra_args: --user

- name: pipx do the path thing
  ansible.builtin.command: python3 -m pipx ensurepath

- name: must have wezterm
  ansible.builtin.dnf:
    name: https://github.com/wez/wezterm/releases/download/nightly/wezterm-nightly-fedora36.rpm
    state: installed

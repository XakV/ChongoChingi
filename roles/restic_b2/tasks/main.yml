---
- name: install restic
  dnf:
    name: restic
    state: latest
  become: yes

- name: copy the includes file for the host
  copy:
    src: "{{ ansible_hostname }}_restic_includes"
    dest: /home/zach/.restic_includes
    owner: zach
    group: zach
    mode: 0644

- name: unlock the vault
  expect:
    command: /usr/local/bin/bw unlock --raw
    responses:
      password: "{{ bw_passwd }}"
  become: yes
  become_user: zach
  register: bitwarden_vault

- name: record the bw session response
  set_fact:
    bw_session: "{{ bitwarden_vault.stdout_lines[1] }}"
  
- name: create fact for restic passwd cmd shell var
  shell: |
      /usr/local/bin/bw list items --session {{ bw_session }} --search restic_b2 | /usr/bin/jq .[0].login.password
  become: yes
  become_user: zach
  register: restic_sekret

- name: create the sekret password file
  copy:
    content: "{{ restic_sekret.stdout }}"
    dest: /home/zach/.repo_sekret
    owner: zach
    group: zach
    mode: 0600
  become: yes
  become_user: zach
 
- name: copy cron.allow is important
  copy:
    src: cron.allow
    dest: /etc/cron.allow
    owner: root
    group: root
    mode: 0644    
  become: True

- name: restic environment vars
  blockinfile:
    path: /home/zach/.bash_profile
    block: |
      export RESTIC_REPOSITORY={{ restic_env[ansible_hostname]['repo'] }}
      export B2_ACCOUNT_ID={{ restic_env[ansible_hostname]['b2_account'] }}
      export B2_ACCOUNT_KEY={{ restic_env[ansible_hostname]['b2_key'] }}
    owner: zach
    group: zach
    mode: 0640

- name: schedule backups
  cron: 
    name: "backup_{{ ansible_hostname }}"
    hour: 01
    minute: 15
    weekday: 1
    job: |
      "/usr/bin/restic -r b2:{{ restic_env[ansible_hostname]['repo'] }} backup --files-from /home/zach/.restic_includes --password-file=/home/zach/.repo_sekret"

- name: prune daily backups
  cron:
    name: "prune_{{ ansible_hostname }}"
    weekday: 0
    hour: 1
    minute: 30
    job: |
      "restic -r b2:{{ restic_env[ansible_hostname]['repo'] }} forget --keep-last 10 keep-weekly 4 --keep-monthly 3 --keep-yearly 1 --prune --password-file=/home/zach/.repo.sekret"

- name: enable start cron
  systemd:
    name: crond
    state: restarted
    enabled: yes
    daemon-reload: yes
